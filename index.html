<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>El Misterio de los Corazones Rotos</title>
    <style>
        /* --- FUENTES Y VARIABLES --- */
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap');

        :root {
            --bg-gradient: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            --primary: #5dade2;
            --secondary: #ec7063;
            --accent: #f4d03f;
            --success: #58d68d;
            --text: #2c3e50;
            --card-bg: #ffffff;
            --font-main: 'Quicksand', sans-serif;
        }

        /* --- ESTRUCTURA GENERAL --- */
        body {
            font-family: var(--font-main);
            background: var(--bg-gradient);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh; /* Altura completa de la ventana */
            width: 100vw;
            overflow: hidden; /* Evita scroll en el body, lo manejamos en la tarjeta */
            color: var(--text);
            user-select: none;
        }

        /* --- CONTENEDOR DE JUEGO RESPONSIVO --- */
        #game-container {
            background-color: var(--card-bg);
            width: 90%;
            max-width: 550px;
            /* Altura din√°mica: se ajusta al contenido pero nunca se sale de la pantalla */
            max-height: 95vh; 
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            padding: 20px;
            text-align: center;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 4px solid #fff;
            
            /* Permite scroll interno si la pantalla es muy bajita */
            overflow-y: auto; 
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: var(--primary) #f0f0f0;
        }

        /* Estilo del scrollbar para Chrome/Safari */
        #game-container::-webkit-scrollbar { width: 8px; }
        #game-container::-webkit-scrollbar-track { background: #f0f0f0; border-radius: 10px; }
        #game-container::-webkit-scrollbar-thumb { background-color: var(--primary); border-radius: 10px; }

        /* --- TIPOGRAF√çA ADAPTABLE --- */
        h1 { 
            color: #2e86c1; 
            font-size: clamp(1.5rem, 4vw, 2rem); /* Se adapta entre 1.5 y 2rem */
            margin: 5px 0 15px 0; 
            line-height: 1.1; 
        }
        
        h2 { 
            color: #884ea0; 
            font-size: clamp(1.2rem, 3vw, 1.5rem);
            margin: 5px 0 10px 0; 
        }

        p { 
            font-size: clamp(1rem, 2.5vw, 1.2rem); 
            line-height: 1.4; 
            margin-bottom: 15px; 
            color: #555; 
        }

        /* --- ELEMENTOS VISUALES --- */
        .character-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        /* Emojis flexibles */
        .emoji-lg { font-size: clamp(4rem, 10vw, 6rem); transition: transform 0.3s; }
        .emoji-md { font-size: clamp(3rem, 8vw, 4rem); }
        .heart-lg { font-size: clamp(4rem, 12vw, 7rem); margin: 5px 0; display: inline-block; }

        /* --- ANIMACIONES --- */
        @keyframes heartbeat { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 25% { transform: translate(-3px, 0px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 75% { transform: translate(3px, 1px) rotate(-1deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes talking { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .anim-pulse { animation: heartbeat 1.5s infinite; }
        .anim-shake { animation: shake 0.5s; }
        .anim-pop { animation: popIn 0.3s ease-out forwards; }
        .anim-talk { animation: talking 0.2s infinite; }

        /* --- BOTONES --- */
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 10px; /* Menos espacio entre botones */
            width: 100%;
            margin-top: 10px;
        }

        button {
            border: none;
            padding: 12px 20px; /* Padding reducido para pantallas peque√±as */
            border-radius: 15px;
            font-family: var(--font-main);
            font-size: clamp(0.9rem, 2.5vw, 1.1rem);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            width: 100%;
            min-height: 50px; /* Asegura √°rea t√°ctil */
        }

        button:active { transform: translateY(2px); box-shadow: none; }
        button:hover { filter: brightness(1.05); }

        .btn-start { background-color: var(--success); color: white; font-size: 1.3rem; padding: 15px; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-next { background-color: var(--accent); color: #555; }
        
        .btn-logic { background-color: #d6dbdf; color: #555; border: 2px solid #bdc3c7; }
        .btn-empathy { background-color: #abebc6; color: #186a3b; border: 2px solid #58d68d; }
        .btn-negative { background-color: #fadbd8; color: #943126; border: 2px solid #ec7063; }

        /* Bot√≥n Audio */
        .audio-btn {
            background: #fff;
            color: var(--primary);
            border: 2px solid var(--primary);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            min-height: 45px;
            padding: 0;
            display: inline-flex;
            font-size: 1.2rem;
            margin-left: 10px;
            box-shadow: none;
            vertical-align: middle;
            flex-shrink: 0; /* Evita que se aplaste */
        }

        /* --- INTERFAZ BOT --- */
        .bot-interface {
            background-color: #2c3e50;
            color: #58d68d;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            width: 100%;
            box-sizing: border-box;
            border: 3px solid #bdc3c7;
            text-align: left;
            margin: 10px 0;
            font-size: 0.9rem;
        }

        /* --- ESCENAS --- */
        .scene { display: none; width: 100%; }
        .scene.active { display: block; animation: popIn 0.3s ease; }

        /* --- PROGRESO --- */
        .progress-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        .progress-dot {
            width: 10px;
            height: 10px;
            background-color: #ddd;
            border-radius: 50%;
        }
        .progress-dot.active { background-color: var(--success); }

        /* --- CONFETI --- */
        .confetti { position: absolute; width: 10px; height: 10px; top: -10px; z-index: 999; animation: fall linear forwards; border-radius: 50%; }
        @keyframes fall { to { transform: translateY(110vh) rotate(720deg); } }

        /* --- MEDIA QUERIES PARA PANTALLAS PEQUE√ëAS (M√ìVILES) --- */
        @media (max-width: 480px) {
            #game-container {
                padding: 15px;
                width: 95%;
            }
            h1 { font-size: 1.4rem; }
            .emoji-lg { font-size: 3.5rem; }
            .emoji-md { font-size: 2.5rem; }
            button { padding: 10px 15px; min-height: 45px; }
            .bot-interface { padding: 10px; font-size: 0.8rem; }
        }

        /* --- MEDIA QUERIES PARA PANTALLAS BAJAS (LANDSCAPE CELULAR/LAPTOP) --- */
        @media (max-height: 650px) {
            h1 { margin: 5px 0; font-size: 1.3rem; }
            p { margin-bottom: 8px; font-size: 0.95rem; }
            .emoji-lg { font-size: 3rem; margin: 0; }
            .heart-lg { font-size: 4rem; margin: 0; }
            .bot-interface { padding: 8px; margin: 5px 0; }
            button { padding: 8px; min-height: 40px; }
            .btn-group { gap: 6px; }
        }

    </style>
</head>
<body>

    <div id="game-container">
        
        <!-- UI: Puntos de Progreso -->
        <div class="progress-bar" id="progress-container" style="display:none;">
            <div class="progress-dot" id="dot-0"></div>
            <div class="progress-dot" id="dot-1"></div>
            <div class="progress-dot" id="dot-2"></div>
        </div>

        <!-- ESCENA 0: INICIO -->
        <div id="start-screen" class="scene active">
            <div class="emoji-lg anim-pulse">‚ù§Ô∏è</div>
            <h1>Corazones Rotos</h1>
            <p>Juego de Empat√≠a para 1¬∞ Primaria</p>
            <p style="font-size: 0.9rem; color: #888;">üîä Activa tu sonido</p>
            <button class="btn-start" onclick="game.init()">¬°Jugar! ‚ñ∂Ô∏è</button>
        </div>

        <!-- ESCENA 1: INTRO -->
        <div id="intro-scene" class="scene">
            <div class="character-container">
                <div class="emoji-md" id="guardian-avatar">üë©‚Äçüè´</div>
                <div class="emoji-md" id="bot-avatar">ü§ñ</div>
            </div>
            <h2>La Misi√≥n</h2>
            <div id="intro-text-container">
                <p>Soy la Guardiana y √©l es <strong>Bot-L√≥gico</strong>.</p>
                <p>Bot es un genio üß†, pero <strong>no tiene coraz√≥n</strong>. No entiende los sentimientos.</p>
                <p>Ay√∫danos a usar la <strong>Empat√≠a</strong>.</p>
            </div>
            <button class="btn-primary" onclick="game.startLevel()">¬°Entendido! üëç</button>
        </div>

        <!-- ESCENA 2: PROBLEMA -->
        <div id="problem-scene" class="scene">
            <h2 id="level-title">Misi√≥n 1</h2>
            <div style="display:flex; align-items:center; justify-content:center; gap:10px;">
                <div class="emoji-lg anim-shake" id="friend-emoji">üëß</div>
                <div class="heart-lg anim-pulse">üíî</div>
            </div>
            <div style="display:flex; align-items:center; justify-content:center; margin-bottom:15px;">
                <p id="problem-text" style="margin:0;">...</p>
                <button class="audio-btn" onclick="voice.speakCurrent()">üîä</button>
            </div>
            <button class="btn-primary" onclick="game.showBotIntervention()">Ver qu√© dice Bot ü§ñ</button>
        </div>

        <!-- ESCENA 3: BOT -->
        <div id="bot-scene" class="scene">
            <div class="emoji-md" id="bot-face">ü§ñ</div>
            <h2>Bot-L√≥gico dice:</h2>
            <div class="bot-interface">
                <p id="bot-solution-text">...</p>
            </div>
            <p>Es l√≥gico... ¬øpero es amable?</p>
            <button class="btn-primary" onclick="game.showChoices()">Tengo una mejor idea üí°</button>
        </div>

        <!-- ESCENA 4: DECISI√ìN -->
        <div id="choice-scene" class="scene">
            <div class="emoji-md" id="choice-friend-emoji">üëß</div>
            <p>¬øQu√© har√≠as t√∫?</p>
            <div class="btn-group" id="choices-container">
                <!-- Botones din√°micos -->
            </div>
        </div>

        <!-- ESCENA 5: FEEDBACK -->
        <div id="feedback-scene" class="scene">
            <div style="display:flex; justify-content:center; align-items:center; gap:10px;">
                <div class="emoji-lg" id="feedback-friend-emoji"></div>
                <div class="heart-lg" id="feedback-heart"></div>
            </div>
            <h2 id="feedback-title"></h2>
            <p id="feedback-message"></p>
            <div id="feedback-action" style="margin-top:10px; width:100%;"></div>
        </div>

        <!-- ESCENA 6: VICTORIA -->
        <div id="victory-scene" class="scene">
            <div class="emoji-lg anim-pulse">üíñüéâ</div>
            <h1>¬°Misi√≥n Cumplida!</h1>
            <p>Has ense√±ado a Bot que el coraz√≥n es lo m√°s importante.</p>
            <p><strong>¬°Eres un Maestro de la Empat√≠a!</strong></p>
            <button class="btn-start" onclick="location.reload()">Jugar otra vez üîÑ</button>
        </div>

    </div>

    <script>
        /* --- GESTOR DE AUDIO (TTS) --- */
        class VoiceManager {
            constructor() {
                this.synth = window.speechSynthesis;
                this.lastText = "";
                // Intentar cargar voces
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = () => this.synth.getVoices();
                }
            }

            speak(text, type = 'narrator') {
                if (this.synth.speaking) this.synth.cancel();
                this.lastText = text;
                
                const utterance = new SpeechSynthesisUtterance(text);
                const voices = this.synth.getVoices();
                // Preferir voz en espa√±ol
                const esVoice = voices.find(v => v.lang.includes('es'));
                if (esVoice) utterance.voice = esVoice;

                if (type === 'bot') {
                    utterance.pitch = 0.8; utterance.rate = 1.1;
                } else {
                    utterance.pitch = 1.2; utterance.rate = 1.0;
                }

                // Animaci√≥n simple al hablar
                utterance.onstart = () => {
                   const avatar = type === 'bot' ? document.getElementById('bot-face') : document.getElementById('guardian-avatar');
                   if(avatar) avatar.classList.add('anim-talk');
                };
                utterance.onend = () => {
                   document.querySelectorAll('.anim-talk').forEach(el => el.classList.remove('anim-talk'));
                };

                this.synth.speak(utterance);
            }

            speakCurrent() { if (this.lastText) this.speak(this.lastText, 'narrator'); }
            stop() { this.synth.cancel(); }
        }

        /* --- SFX SIMPLE --- */
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const playTone = (freq, type) => {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.value = freq;
            gain.gain.value = 0.05;
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.3);
        };

        /* --- DATOS --- */
        const levels = [
            {
                id: 1, friendName: "Ana", friendEmoji: "üëß",
                problem: "Ana llora porque se rompi√≥ su dibujo.",
                botText: "Datos: Papel roto. Soluci√≥n: Imprimir copia.",
                options: [
                    { type: 'logic', text: "Imprimir copia", icon: "üìÑ" },
                    { type: 'empathy', text: "Abrazar y dibujar juntas", icon: "ü§ó" },
                    { type: 'negative', text: "Decirle 'No llores'", icon: "üòê" }
                ],
                responses: {
                    empathy: { text: "¬°Ana sonr√≠e! El cari√±o arregl√≥ su coraz√≥n.", title: "¬°Muy bien!" },
                    logic: { text: "Ana sigue triste. La copia no es igual.", title: "Muy fr√≠o..." },
                    negative: { text: "Ana llora m√°s fuerte.", title: "¬°Oh no!" }
                }
            },
            {
                id: 2, friendName: "Leo", friendEmoji: "üë¶",
                problem: "Leo tiene miedo de la cueva oscura.",
                botText: "Datos: Oscuridad 100%. Peligro 0%.",
                options: [
                    { type: 'negative', text: "Decirle 'Miedoso'", icon: "üò†" },
                    { type: 'empathy', text: "Darle la mano y entrar", icon: "ü§ù" },
                    { type: 'logic', text: "Explicar datos", icon: "üìä" }
                ],
                responses: {
                    empathy: { text: "Con tu ayuda, Leo fue valiente.", title: "¬°Excelente!" },
                    logic: { text: "Leo entiende, pero sigue temblando.", title: "Falta empat√≠a" },
                    negative: { text: "Leo se fue corriendo.", title: "Mal hecho" }
                }
            },
            {
                id: 3, friendName: "Amigos", friendEmoji: "‚öΩ",
                problem: "Pelean: ¬øF√∫tbol o B√°squet?",
                botText: "Soluci√≥n: 10 min uno y 10 min otro.",
                options: [
                    { type: 'empathy', text: "Inventar juego mezclado", icon: "üí°" },
                    { type: 'logic', text: "Usar cron√≥metro", icon: "‚è±Ô∏è" },
                    { type: 'negative', text: "Lanzar moneda", icon: "ü™ô" }
                ],
                responses: {
                    empathy: { text: "¬°Inventaron el F√∫t-Basket!", title: "¬°Genial!" },
                    logic: { text: "Juegan aburridos mirando el reloj.", title: "Aburrido" },
                    negative: { text: "Siguen peleando.", title: "No funcion√≥" }
                }
            }
        ];

        /* --- L√ìGICA JUEGO --- */
        class Game {
            constructor() { this.level = 0; }
            
            init() {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                document.getElementById('progress-container').style.display = 'flex';
                this.switchScene('intro-scene');
                setTimeout(() => voice.speak("Hola soy la Guardiana. Ayuda a Bot L√≥gico a entender los sentimientos.", 'narrator'), 500);
            }

            switchScene(id) {
                document.querySelectorAll('.scene').forEach(el => el.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                playTone(400, 'sine');
                // Scroll al top del contenedor por si acaso
                document.getElementById('game-container').scrollTop = 0;
            }

            startLevel() {
                if (this.level >= levels.length) return this.victory();
                this.updateDots();
                const l = levels[this.level];
                
                document.getElementById('level-title').innerText = `Misi√≥n ${l.id}: ${l.friendName}`;
                document.getElementById('friend-emoji').innerText = l.friendEmoji;
                document.getElementById('problem-text').innerText = l.problem;
                
                this.switchScene('problem-scene');
                setTimeout(() => voice.speak(l.problem, 'narrator'), 500);
            }

            showBotIntervention() {
                const l = levels[this.level];
                document.getElementById('bot-solution-text').innerText = l.botText;
                this.switchScene('bot-scene');
                playTone(200, 'square');
                setTimeout(() => voice.speak(l.botText, 'bot'), 500);
            }

            showChoices() {
                const l = levels[this.level];
                document.getElementById('choice-friend-emoji').innerText = l.friendEmoji;
                const c = document.getElementById('choices-container');
                c.innerHTML = '';
                l.options.forEach(opt => {
                    const b = document.createElement('button');
                    b.className = `btn-${opt.type}`;
                    b.innerHTML = `<span>${opt.icon}</span> ${opt.text}`;
                    b.onclick = () => this.handle(opt.type);
                    c.appendChild(b);
                });
                this.switchScene('choice-scene');
                voice.stop();
            }

            handle(type) {
                const l = levels[this.level];
                const res = l.responses[type];
                const title = document.getElementById('feedback-title');
                const msg = document.getElementById('feedback-message');
                const emoji = document.getElementById('feedback-friend-emoji');
                const heart = document.getElementById('feedback-heart');
                const act = document.getElementById('feedback-action');

                emoji.innerText = l.friendEmoji;
                title.innerText = res.title;
                msg.innerText = res.text;
                heart.className = 'heart-lg'; 

                if (type === 'empathy') {
                    playTone(600, 'triangle');
                    this.confetti();
                    title.style.color = "var(--success)";
                    heart.innerText = "üíñ";
                    heart.classList.add('anim-pulse');
                    emoji.innerText = "üòÑ";
                    act.innerHTML = `<button class="btn-next" onclick="game.next()">Siguiente ‚û°Ô∏è</button>`;
                } else {
                    playTone(150, 'sawtooth');
                    title.style.color = type === 'logic' ? "#999" : "var(--secondary)";
                    heart.innerText = type === 'logic' ? "üíî" : "üñ§";
                    emoji.innerText = type === 'logic' ? "üòê" : "üò≠";
                    act.innerHTML = `<button class="btn-primary" onclick="game.showChoices()">Intentar ‚Ü©Ô∏è</button>`;
                }
                this.switchScene('feedback-scene');
                voice.speak(res.text, 'narrator');
            }

            next() { this.level++; this.startLevel(); }
            
            updateDots() {
                document.querySelectorAll('.progress-dot').forEach((d, i) => d.classList.toggle('active', i <= this.level));
            }

            victory() {
                this.switchScene('victory-scene');
                playTone(600, 'triangle');
                this.confetti();
                voice.speak("¬°Felicidades! Eres un maestro de la empat√≠a.", 'narrator');
            }

            confetti() {
                const colors = ['#f4d03f', '#58d68d', '#5dade2'];
                for(let i=0; i<30; i++) {
                    const d = document.createElement('div');
                    d.className = 'confetti';
                    d.style.left = Math.random()*100+'%';
                    d.style.background = colors[Math.floor(Math.random()*3)];
                    d.style.animationDuration = (Math.random()*2+2)+'s';
                    document.body.appendChild(d);
                    setTimeout(()=>d.remove(), 4000);
                }
            }
        }

        const voice = new VoiceManager();
        const game = new Game();
    </script>
</body>
</html>
